# 线上问题整理

| 痛点整理                                      | 备注:                                                                                                                                                                      | 问题分析                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 搜索召回:搜索“鸡翅中”出来结果不相干,在价格排序中更加明显.           | 反复出现:<br><br>- 搜索牛肉片，自营品牛肉片排序不靠前；<br>- 搜索了 牛肉饼 饼干 排名靠前的也是无关的品<br>- 山药粉,排名靠前的事就痒豆浆, 豆浆粉.<br>- 搜索饼干,罐头排在前面<br>- 搜索腰果, 纯牛奶排在前面<br>- 搜索牛腱子, 洗衣机排在前面<br>- 搜索秋衣 酸奶排在前面<br><br> | - 本质上是搜索流程的问题:<br><br>目前搜索技术架构仅仅依赖于es, ES是个开箱即用的<font color=Red>**全文**</font>搜索引擎, 默认内置tf-idf排序算法适用于网页排序,不适合电商商品排序(<font color=Blue>IDF逆向文件频率: 一个词在全部商品中出现的频率越高,则它越不重要</font>)<br>电商<font color=Red>搜索流程</font>里必须包含业务规则,而不能完全依赖es的模糊搜索策略.脱离掌控的搜索流程必然会造成很多很魔幻的搜索结果.<br><br>- 问题的解决步骤:<br><br>建设电商自己的搜索流程,包含离线和在线两个流程.<br><br>1. 1. 离线上,搜索需要有自己的库,需要实现自己的业务逻辑. 只有有自己的库才能理解并解决“领30元券包“,“董宇辉“ 空结果的问题.<br>  2. 在线搜索流程上,必须接管ES的搜索流程. 只有接管ES搜索流程才能精确控制搜索的字段.<br>    1. 离线上会对商品新增“标签”,“主播”等字段<br>    2. 在线搜索,需区分命中标签,和命中商品名称两种情况. 命中名称的排名应该靠前.<br>  3. 需重新定义搜索结果相关性排序. tf-idf肯定是不能用的. 但<font color=red>合理的排序公式需要探索</font>.<br><br><br> |
| 搜索召回-关联商品召回:搜索功能差，几乎很难通过搜索功能搜索到想买的商品，体验很差 | 红薯. 654pv, 154点击.   用户应该不是想搜我们给出的结果.对比山药:688pv, 786点击.                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 搜索Switch相关结果较差                            | <br>                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 模糊搜索不是或者关联搜索是不是想办法再强化一下                   | 例如:线上的真实case热搜词: "意大利面 "(1,130pv), 无法用"意面"(928pv)搜索出来"哈密冰糖薯“ 无法用”红薯“/”白薯“ 搜出来.老白干，搜酒就没出来                                                                                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 搜索无结果                                     | 11月28日上线一版同义词. 效果不好,回滚了.热搜词:“领30元券包“(664pv,610uv),无结果 ”董宇辉“ (662pv,597uv),无结果"自营烤肠溯源"(526pv,461uv),无结果                                                                   | 待自定义搜索流程上线后, 可通过在对应的商品上打上响应标签来解决这类空结果问题.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 直播商品提权                                    | <br>                                                                                                                                                                     | 自定义排序算法,可由业务指定加权值,或者直接指定TopN.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

## 搜索词与ES的文档结构

1. ES文档是以倒排索引为核心的存储结构. 

2. 倒排拉链里存着doc ID, 再根据doc ID 查找文档所属的正排字段.  通过组装形成我们看到的json格式的文档.

3. $\color{Red}正确获得搜索结果的前提$是: 对搜索词和文档内容采用相同的分词算法.



## 目前现状:

![image2023-12-21_12-45-44.png](/Users/zhoujunsheng/Documents/jackson-zhou.github.io/_data/images/fcc8e5a01f44f61d5568c897d827166164744dbe.png)

[目前线上的查询DSL](https://confluence.koolearn-inc.com/pages/viewpage.action?pageId=85877111)只是一个从0到1的过程, 现在需要进行精简/优化.

目前线上的ES文档, 主要检索字段(例如:name)采用的是默认分词standard, 也就是单字分词. 导致搜索效果不佳.

# 优化方案

## 1, 对查询词和文档字段采用相同的ik分词器.

IK分词器有两种分词模式：ik_max_word和ik_smart模式。对建库采用“ik_max_word“ 分词器分词.  对搜索词采用“ik_smart“分词.

ik_max_word会对句子尽可能的分出更多的词, 例如:“牛羊肉“, 会被分为: ”牛羊肉“/”牛羊“/”羊肉“,  

ik_smart这个分词模式的颗粒度比较粗,例如:“牛羊肉“, 只会被分为: ”牛羊肉“.

## 2, 检索流程不再完全依赖ES

![image2023-12-21_16-36-7.png](/Users/zhoujunsheng/Documents/jackson-zhou.github.io/_data/images/83e352a880be549372337a1adc22d21fd96f3e59.png)





## 检索DSL

| 步骤       | DSL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 备注                                                                                                                                                    |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| 搜名称      | {<br>    "from":0,<br>    "size":300,<br>    "query":{<br>        "bool":{<br>            "filter":[<br>                {<br>                    "term":{<br>                        "onlineStatus":{<br>                            "value":2,<br>                            "boost":1<br>                        }<br>                    }<br>                }<br>            ],<br>            "must":[<br>                {<br>                    "terms":{<br>                        "name":[<br>                            "苹果",<br>                            "派"<br>                        ]<br>                    }<br>                }<br>            ],<br>            "should":[<br>                {<br>                    "terms":{<br>                        "name":[<br>                            "好吃"<br>                        ]<br>                    }<br>                }<br>            ]<br>        }<br>    },<br>    "highlight":{<br>        "fields":{<br>            "name":{}<br>        }<br>    },<br>    "_source":{<br>        "includes":[<br>            "goodsId",<br>            "name"<br>        ]<br>    }<br>} | - 只返回300条记录.<br>- 使用term查询, 不让ES的搜索流程再次进行分词操作.<br>- 只返回goodsId,name, 其它字段调用goods_b信息补全<br>- 实体词用must查询, 多个实体词之间是OR的关系.<br>- 修饰词用should查询,多个修饰词之间是OR关系 |
| 同义词查询    | {<br>    "from":0,<br>    "size":300,<br>    "query":{<br>        "bool":{<br>            "filter":[<br>                {<br>                    "term":{<br>                        "onlineStatus":{<br>                            "value":2,<br>                            "boost":1<br>                        }<br>                    }<br>                }<br>            ],<br>            "must":[<br>                {<br>                    "terms":{<br>                        "name":["西红柿","番茄","仙女果"]<br>                    }<br>                }<br>            ],<br>            "should":[<br>                {<br>                    "terms":{<br>                        "name":["好吃" ]<br>                    }<br>                }<br>            ]<br>        }<br>    },<br>    "highlight":{<br>        "fields":{<br>            "name":{}<br>        }<br>    },<br>    "_source":{<br>        "includes":[<br>            "goodsId",<br>            "name"<br>        ]<br>    }<br>}                                                                                                                                                | - 明确进行同义词扩大查询范围, 它的优先级小于原词查询.<br>- 查询仍局限在name字段<br>- 对于多个同义词,适用一次查询.之间是OR关系<br>- 不用ES的同义词查询.<br>- 使用term查询,不用ES再次分词.                                  |
| 拓展词查询    | {<br>    "from":0,<br>    "size":300,<br>    "query":{<br>        "bool":{<br>            "filter":[<br>                {<br>                    "term":{<br>                        "onlineStatus":{<br>                            "value":2,<br>                            "boost":1<br>                        }<br>                    }<br>                }<br>            ],<br>            "must":[<br>                {<br>                    "terms":{<br>                        "name":["土豆","洋葱","红萝卜","蔬菜"]<br>                    }<br>                }<br>            ],<br>            "should":[<br>                {<br>                    "terms":{<br>                        "name":["好吃" ]<br>                    }<br>                }<br>            ]<br>        }<br>    },<br>    "highlight":{<br>        "fields":{<br>            "name":{}<br>        }<br>    },<br>    "_source":{<br>        "includes":[<br>            "goodsId",<br>            "name"<br>        ]<br>    }<br>}                                                                                                                                            | - 明确进行拓展词扩大查询范围, 它的优先级小于原词查询和同义词查询<br>- 查询仍局限在name字段<br>- 对于多个同义词,适用一次查询.之间是OR关系<br>- 不用ES的同义词查询.<br>- 使用term查询,不用ES再次分词.                             |
| 品牌       | {<br>    "from":0,<br>    "size":300,<br>    "query":{<br>        "bool":{<br>            "filter":[<br>                {<br>                    "term":{<br>                        "onlineStatus":{<br>                            "value":2,<br>                            "boost":1<br>                        }<br>                    }<br>                }<br>            ],<br>            "must":[<br>                {<br>                    "terms":{<br>                        "brandName":["土豆"]<br>                    }<br>                }<br>            ]<br>        }<br>    },<br>    "highlight":{<br>        "fields":{<br>            "brandName":{}<br>        }<br>    },<br>    "_source":{<br>        "includes":[<br>            "goodsId",<br>            "name"<br>        ]<br>    }<br>}                                                                                                                                                                                                                                                                                                                                            | - 明确指定品牌查询<br>- 使用term查询,不用ES再次分词                                                                                                                     |
| 标签、主播、金句 | {<br>    "from":0,<br>    "size":300,<br>    "query":{<br>        "bool":{<br>            "filter":[<br>                {<br>                    "term":{<br>                        "onlineStatus":{<br>                            "value":2,<br>                            "boost":1<br>                        }<br>                    }<br>                }<br>            ],<br>             "highlight":{<br>                    "fields":{<br>                        "*":{}<br>                    }<br>             },<br>            "should":[<br>                {<br>                    "terms":{<br>                        "tag":["兵马俑","一句顶一万句"],<br>                        "anchor":["兵马俑","一句顶一万句"],<br>                        "verse":["兵马俑","一句顶一万句"],<br>                    }<br>                }<br>            ]<br>        }<br>    },<br>    "highlight":{<br>        "fields":{<br>            "brandName":{}<br>        }<br>    },<br>    "_source":{<br>        "includes":[<br>            "goodsId",<br>            "name"<br>        ]<br>    }<br>}                                                                            | - 三者可以不做区分.只管搜就行<br>- 之间是OR关系                                                                                                                         |

# 实体词词典

它需要和分词辞典配合使用

> 乌贼饼         1.0
> 
> 乌饭            1.0
> 
> 乌鸡            1.0
> 
> 乌龙奶茶    1.0
> 
> 乌龙茶        1.0
> 
> 乌龙茶组合 1.0
> 
> 乌龙茶饮料 1.0
> 
> ........

## 拓展词词典

拓展词需要和分词辞典配合使用.  包括主题词和拓展词. 

拓展词不会再次进行分词,防止bad case. 

- 例如: 茶扩展为冲泡茶, 分词“冲“,”泡茶“
- “冲”召回“冲模抗菌内衣”

只有实体词才会被拓展, 其它词不会. 例如“好吃的西红柿“, ”西红柿“会被拓展,但”好吃的“不会.

茶:茶叶,袋泡茶,茗茶,品鉴茶,便携茶,礼盒茶,茶饼,散茶,春茶,冲泡茶白茶:白牡丹,寿眉,白毫银针,白毫,银针,老白茶菊花茶:胎菊茶,头采茶

# 排序算法

核心诉求:

- 直观: 通过搜索词与商品名称,大致能猜出商品的排列顺序.
- 自营品加权
- 运营加权
- 运营置顶

彻底不使用tf-idf得分算法. 改为自定义得分排序

命中实体词,得0.01分.

命中非实体词,得0.001分

搜索得分:  

∑(命中实体词分值 + 调权:命中词占字段词的比重*命中实体词分值) + ∑(命中非实体词分值 + 调权:命中词占字段词的比重*命中非实体词分值)+自营品加权(0.5)+运营加权

例如:

“鸡翅中” 召回:

- "大江 鸡翅中 500g/袋*3袋"
- "大江鸡翅根1kg*2"
- "东方甄选奥尔良鸡翅 (翅中+翅根) 1000g/袋 营养美味"(自营)
- "宏家高端鸡翅木筷子实木整切防霉抗菌防滑无漆无蜡家用筷"

则 

"大江 鸡翅中 500g/袋*3袋" 得分: (0.01+2/34*0.01) + (0.001+1/34*0.001) =0.011617647    实际命中字段为:大江 <em>鸡翅</em><em>中</em> 500g/袋*3袋

"大江鸡翅根1kg*2"得分:  (0.01+2/19*0.01) = 0.011052631 实际命中字段为:大江<em>鸡翅</em>根1kg*2

"东方甄选奥尔良鸡翅 (翅中+翅根) 1000g/袋 营养美味"(自营)得分:(0.01+2/48*0.01) + (0.001+1/48*0.001)  + 自营0.5 = 0.0114375 +0.5 = 0.5114375

"宏家高端鸡翅木筷子实木整切防霉抗菌防滑无漆无蜡家用筷"得分:(0.01+2/39*0.01) = 0.0105128

排序为:

"东方甄选奥尔良鸡翅 (翅中+翅根) 1000g/袋 营养美味"

"大江 鸡翅中 500g/袋*3袋"

"大江鸡翅根1kg*2"

"宏家高端鸡翅木筷子实木整切防霉抗菌防滑无漆无蜡家用筷"

# 拓展词规则:

以冒号分割, 左边的是实体词,右边的是拓展词.

只有实体词才会被拓展.

拓展后的词不再进行分词.

注意: 对应的实体词/拓展词需要同步到分词词典中.

苹果:水果,果汁,果酱意面:意大利面

# 其它:

后续会再继续进行:纠错词/搜索sug

例如: 用户输入"韭", 会提示他是否想搜"韭菜"/"酒"/"茅台"?

当统计上发现用户经常输入的错别字, 会自动进行纠错处理, 例如"九菜"会被纠成"韭菜"

这部分功能需要算法支持. 需要先评估ROI再决定优先级.

![搜索流程改造.png](/Users/zhoujunsheng/Documents/jackson-zhou.github.io/_data/images/1123029a6df88363fec9135b70de79d0fd8888a6.png)

# 
